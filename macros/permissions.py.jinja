{# Paths format
  [
    {
      "mount_path": "/data1",
      "uid": 1000,
      "gid": 1000,
      "mode": "0644"
      "force": False
    },
  ]

 #}
{%- macro apply_permissions(paths = []) -%}
import pathlib
import os

paths = [{% for item in paths %} {{ item | tojson }}, {% endfor %}]

if not paths:
  print("No paths to apply permissions to")
  return

for item in paths:
  if not pathlib.Path(item['path']).exists():
    raise Exception(f"Path [{item['path']}] does not exist")
  if any(pathlib.Path(item['path']).iterdir()) and not item.get("force", False):
    raise Exception(f"Path [{item['path']}] is not empty, skipping... Use [force=True] to override")

  if item.get("uid", None) and item.get("gid", None):
    print(f"Changing owner of [{item['path']}] to [{item['uid']}:{item['gid']}]")
    os.chown(item['path'], int(item['uid']), int(item['gid']))
    print("New owner:", (os.stat(item['path']).st_uid, os.stat(item['path']).st_gid))

  if item.get("mode", None):
    print(f"Changing mode of [{item['path']}] to [{item['mode']}]")
    os.chmod(item['path'], int(item['mode'], 8))
    print("New mode:", (os.stat(item['path']).st_mode).to_octal())
{% endmacro %}
